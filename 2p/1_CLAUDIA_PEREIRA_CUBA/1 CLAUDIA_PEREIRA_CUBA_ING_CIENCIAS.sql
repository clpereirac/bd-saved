-- CLAUDIA PEREIRA CUBA ING CIENCIAS DE LA COMPUTACIÃ“N
CREATE DATABASE PROVEEDORES
CHARACTER SET utf8 COLLATE utf8_general_ci;

USE PROVEEDORES; 

CREATE TABLE PROVEEDOR ( 
    NITP CHAR(11) NOT NULL PRIMARY KEY, 
    NOMBRE VARCHAR(35) DEFAULT ' ', 
    TELEFONO INT(5) DEFAULT 0 
) ENGINE = InnoDB; 

CREATE TABLE ODONTOLOGO ( 
    IDEO CHAR(6) NOT NULL PRIMARY KEY, 
    NOMBREODO VARCHAR(35) DEFAULT ' ', 
    NITP CHAR(11),
    FOREIGN KEY (NITP) REFERENCES PROVEEDOR(NITP) 
) ENGINE = InnoDB; 

CREATE TABLE MATERIAL ( 
    CODIGO CHAR(6) NOT NULL PRIMARY KEY, 
    DESCRIPCION VARCHAR(35) DEFAULT ' ', 
    NSERIE VARCHAR(20) DEFAULT ' '
) ENGINE = InnoDB; 

CREATE TABLE DEPOSITO (
    CODIGO CHAR(6) NOT NULL PRIMARY KEY, 
    CENTRADA INT(4) DEFAULT 0, 
    CSALIDA INT(4) DEFAULT 0,
    CSALDO INT(4) DEFAULT 0, 
    FOREIGN KEY (CODIGO) REFERENCES MATERIAL(CODIGO) 
) ENGINE = InnoDB; 

CREATE TABLE VENTA ( 
    CODIGO CHAR(6) NOT NULL, 
    NITP CHAR(11) NOT NULL, 
    CANTIDADV INT(4) DEFAULT 0,
    FECHAV DATETIME DEFAULT NOW(), 
    PRIMARY KEY(CODIGO, NITP),
    FOREIGN KEY (CODIGO) REFERENCES MATERIAL(CODIGO),
    FOREIGN KEY (NITP) REFERENCES PROVEEDOR(NITP)
) ENGINE = InnoDB; 

CREATE TABLE ENTREGA ( 
    NENT INT(4) NOT NULL PRIMARY KEY, 
    CANTIDADE INT(4) DEFAULT 0, 
    FECHAE DATETIME DEFAULT NOW(), 
    CODIGO CHAR(6), 
    NITP CHAR(11), 
    FOREIGN KEY (CODIGO, NITP) REFERENCES VENTA(CODIGO, NITP) 
) ENGINE = InnoDB; 

INSERT INTO PROVEEDOR VALUES ('111111', 'ODONTO CENTER', 34567), ('222222', 'SERVICIOS ODONTOLOGICO SUCRE', 45673);
INSERT INTO ODONTOLOGO VALUES ('O-0001','MAURICIO VENTURA', '111111'), ('O-0002','FERNANDO RUIZ', '222222');
INSERT INTO MATERIAL VALUES ('M-0001', 'TIJERA CURVA', 23456778), ('M-0002', 'MASA DE ACRILICO', 45327823);
INSERT INTO DEPOSITO VALUES ('M-0001', 10, 6, 4), ('M-0002', 20, 12, 8);
INSERT INTO VENTA VALUES ('M-0001', '111111', 2, NOW()), ('M-0002', '222222', 3, NOW());
INSERT INTO ENTREGA VALUES (1, 2, NOW(), 'M-0001', '111111'), (2, 3, NOW(), 'M-0002', '222222');

/*EJERCICO 1*/
DELIMITER $$
CREATE PROCEDURE EJER1A()
BEGIN
    SELECT 
	P.NOMBRE AS 'NOMBRE DEL PROVEEDOR',
	O.NOMBREODO AS 'NOMBRE DEL ODONTOLOGO',
	AVG(V.CANTIDADV) AS 'PROMEDIO CANTIDAD DE MATERIAL'
    FROM PROVEEDOR P INNER JOIN 
        VENTA V ON P.NITP = V.NITP INNER JOIN 
        ODONTOLOGO O ON V.NITP = O.NITP
    WHERE 
        YEAR(V.FECHAV) = 2022
    GROUP BY P.NITP, O.NITP
    HAVING COUNT(*) >= 1;
END $$
DELIMITER ;
CALL EJER1A();
SELECT * FROM PROVEEDOR;
SELECT * FROM ODONTOLOGO;
SELECT * FROM MATERIAL;
--
/*EJERCICIO 2*/
DELIMITER $$
CREATE PROCEDURE EJE2A(IN DES VARCHAR(35))
BEGIN
    DECLARE CODM CHAR(6);
    IF EXISTS (SELECT * FROM MATERIAL WHERE DESCRIPCION = DES) THEN
	SET CODM = (SELECT CODIGO FROM MATERIAL WHERE DESCRIPCION = DES);
	SELECT O.NOMBREODO AS 'ODONTOLOGO',
			COUNT(*) AS 'NUMERO DE ENTREGAS'
	FROM ODONTOLOGO O INNER JOIN ENTREGA E ON O.NITP = E.NITP
	WHERE E.CODIGO = CODM
	GROUP BY O.NOMBREODO;
    ELSE
        SELECT 'MATERIAL NO REGISTRADO' AS MENSAJE;
    END IF;
END $$
DELIMITER ;
CALL EJE2A('MASA DE ACRILICO');
SELECT * FROM MATERIAL;

/*3b*/
DELIMITER //
CREATE PROCEDURE EJE3B(IN NOMBRE_ODONTOLOGO VARCHAR(35), OUT TOTAL_VENTAS INT, OUT TOTAL_ENTREGAS INT)
BEGIN
    DECLARE NITP_ODONTOLOGO CHAR(11);
    SELECT NITP INTO NITP_ODONTOLOGO FROM ODONTOLOGO WHERE NOMBREODO = NOMBRE_ODONTOLOGO;
    IF NITP_ODONTOLOGO IS NOT NULL THEN
        SELECT (SUM(CANTIDADV)) INTO TOTAL_VENTAS FROM VENTA WHERE NITP = NITP_ODONTOLOGO;
        SELECT (SUM(CANTIDADE)) INTO TOTAL_ENTREGAS FROM ENTREGA WHERE NITP = NITP_ODONTOLOGO;
    ELSE
        SET TOTAL_VENTAS = NULL;
        SET TOTAL_ENTREGAS = NULL;
    END IF;
END //
DELIMITER ;
CALL EJE3B('MAURICIO VENTURA', @TOTAL_VENTAS, @TOTAL_ENTREGAS);
SELECT @TOTAL_VENTAS AS 'TOTAL DE VENTAS', @TOTAL_ENTREGAS AS 'TOTAL DE ENTREGAS';
SELECT * FROM MATERIAL; 
SELECT * FROM ODONTOLOGO;

/*EJERCICIO 4*/
DELIMITER $$
CREATE FUNCTION FUN4A(N1 VARCHAR(35), F1 DATE) RETURNS INT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE COD1 CHAR(6);
    DECLARE NV INT;
    SET COD1 = (SELECT IDEO FROM ODONTOLOGO WHERE NOMBREODO = N1);
    SELECT MAX(CANTIDADV) INTO NV FROM VENTA WHERE NITP = COD1 AND DATE(FECHAV) = F1;
    RETURN NV;
END $$
DELIMITER ;
SELECT FUN4A('MAURICIO VENTURA', '2023-11-10') AS 'NUMERO DE VENTAS';
SELECT * FROM ODONTOLOGO; 
SELECT * FROM VENTA;
